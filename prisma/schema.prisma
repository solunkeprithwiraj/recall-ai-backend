// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

// Users table with age and education level
model User {
    id             String   @id @default(uuid())
    email          String   @unique
    name           String
    password       String
    age            Int?
    educationLevel String // elementary, middle, high_school, college, competitive
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    // Relations
    flashcards      Flashcard[]
    studySessions   StudySession[]
    cardPerformance CardPerformance[]
    learningContext LearningContext[]
    apiUsage        ApiUsage[]
    studyModules    StudyModule[]
    moduleProgress  ModuleProgress[]

    @@map("users")
}

// Study modules - collections of flashcards organized by topic
model StudyModule {
    id              String   @id @default(uuid())
    userId          String
    title           String
    description     String?
    subject         String?
    educationLevel  String?
    difficultyLevel String? // basic, intermediate, advanced, expert
    estimatedHours  Int? // Estimated study time in hours
    topics          String? // JSON array of topics covered
    learningPlan    String? // JSON structured learning plan
    isAIGenerated   Boolean  @default(false)
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    // Relations
    user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    flashcards Flashcard[]
    progress   ModuleProgress[]

    @@map("study_modules")
}

// Flashcards table with embeddings
model Flashcard {
    id              String   @id @default(uuid())
    userId          String
    question        String
    answer          String
    subject         String?
    difficultyLevel String? // basic, intermediate, advanced, expert
    educationLevel  String?
    embedding       String? // Vector embedding as JSON string
    moduleId        String? // Optional reference to study module
    questionType    String? // multiple_choice, true_false, short_answer, fill_in_blank
    options         String? // JSON array of options for multiple choice questions
    isAIGenerated   Boolean  @default(false) // Track if card was generated using AI
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    // Relations
    user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    module          StudyModule?      @relation(fields: [moduleId], references: [id], onDelete: SetNull)
    cardPerformance CardPerformance[]

    @@map("flashcards")
}

// Study sessions with performance tracking
model StudySession {
    id              String    @id @default(uuid())
    userId          String
    sessionType     String // review, new_cards, practice_test
    cardsStudied    Int       @default(0)
    correctAnswers  Int       @default(0)
    sessionDuration Int? // in seconds
    startedAt       DateTime  @default(now())
    completedAt     DateTime?

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("study_sessions")
}

// Individual card performance tracking
model CardPerformance {
    id               String    @id @default(uuid())
    userId           String
    cardId           String
    responseTime     Int? // in milliseconds
    isCorrect        Boolean?
    difficultyRating Int? // 1-5 scale
    nextReviewDate   DateTime?
    reviewCount      Int       @default(0)
    createdAt        DateTime  @default(now())

    // Relations
    user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    card Flashcard @relation(fields: [cardId], references: [id], onDelete: Cascade)

    @@map("card_performance")
}

// Learning context and preferences
model LearningContext {
    id                     String   @id @default(uuid())
    userId                 String
    subject                String?
    proficiencyScore       Float? // 0.0 to 1.0
    learningStyle          String? // visual, auditory, kinesthetic
    preferredSessionLength Int? // in minutes
    culturalContext        String? // Indian curriculum, regional language
    createdAt              DateTime @default(now())
    updatedAt              DateTime @updatedAt

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("learning_context")
}

// API usage tracking
model ApiUsage {
    id             String   @id @default(uuid())
    userId         String
    actionType     String // ai_generation, flashcard_creation, study_session
    tokensUsed     Int      @default(0)
    costUsd        Decimal  @default(0.00) @db.Decimal(10, 4)
    requestSize    Int?
    responseSize   Int?
    processingTime Int? // Time in milliseconds
    createdAt      DateTime @default(now())

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("api_usage")
}

// Module progress tracking - tracks user progress through a study module
model ModuleProgress {
    id               String    @id @default(uuid())
    userId           String
    moduleId         String
    currentCardIndex Int       @default(0) // Index of the last card studied (0-based)
    cardsStudied     Int       @default(0) // Total number of cards studied in this module
    totalCorrect     Int       @default(0) // Total number of correct answers
    accuracy         Float? // Calculated accuracy (0.0 to 1.0)
    lastStudiedAt    DateTime? // Last time user studied this module
    completedAt      DateTime? // When module was completed (all cards studied)
    createdAt        DateTime  @default(now())
    updatedAt        DateTime  @updatedAt

    // Relations
    user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    module StudyModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

    @@unique([userId, moduleId]) // One progress record per user per module
    @@map("module_progress")
}
